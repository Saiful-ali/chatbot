<!-- ========================================
     public/index.html - Main Portal
     ======================================== -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Government Public Health Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white rounded-lg shadow-lg p-6 mb-6">
      <div class="flex justify-between items-center mb-4">
        <div>
          <h1 class="text-3xl font-bold">Government Public Health Portal</h1>
          <p class="text-blue-100">Official health information, alerts, and chatbot assistance</p>
        </div>
        <div>
          <label class="text-sm mr-2">Language:</label>
          <select id="lang" class="px-3 py-1 rounded bg-white text-gray-800">
            <option value="en">English</option>
            <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
            <option value="or">‡¨ì‡¨°‡¨º‡¨ø‡¨Ü</option>
          </select>
        </div>
      </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Chatbot Section -->
      <main class="lg:col-span-2 space-y-6">
        <section class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-2xl font-semibold mb-4">ü§ñ AI Chatbot</h2>
          <div id="chat" class="bg-gray-50 h-96 overflow-y-auto p-4 rounded mb-4 space-y-2"></div>
          <form id="form" class="flex gap-2">
            <input type="text" id="msg" placeholder="Ask about symptoms, vaccines, prevention..." class="flex-1 px-4 py-2 border rounded-lg">
            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">Send</button>
            <button type="button" id="voiceBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">üéôÔ∏è</button>
          </form>
          <p class="text-xs text-gray-500 mt-2">Tip: Click üéôÔ∏è to speak your query</p>
        </section>

        <!-- Learn Section -->
        <section class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-2xl font-semibold mb-4">üìö Learn: Diseases, Vaccines, Prevention</h2>
          <select id="categorySelect" class="w-full mb-4 px-4 py-2 border rounded-lg"></select>
          <div id="learnList" class="space-y-4"></div>
        </section>
      </main>

      <!-- Sidebar -->
      <aside class="space-y-6">
        <!-- Alerts -->
        <section class="bg-red-50 border-l-4 border-red-600 rounded-lg shadow-md p-6">
          <h2 class="text-xl font-semibold text-red-800 mb-4">üö® Active Alerts</h2>
          <button id="refreshAlerts" class="text-sm text-red-600 hover:underline mb-2">Refresh</button>
          <ul id="alerts" class="space-y-2 text-sm"></ul>
        </section>

        <!-- Subscribe -->
        <section class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-semibold mb-4">üì≤ Subscribe for Updates</h2>
          <form id="subForm" class="space-y-3">
            <input type="tel" id="phone" placeholder="Phone (e.g., 9876543210)" class="w-full px-3 py-2 border rounded">
            <input type="text" id="name" placeholder="Name (optional)" class="w-full px-3 py-2 border rounded">
            <label class="flex items-center gap-2">
              <input type="checkbox" id="chWhats" checked> WhatsApp
            </label>
            <label class="flex items-center gap-2">
              <input type="checkbox" id="chSms"> SMS
            </label>
            <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">Subscribe</button>
          </form>
          <p id="subResult" class="text-sm mt-2"></p>
        </section>
      </aside>
    </div>
  </div>

  <script>
    const SERVER = "http://localhost:5000";
    const langSel = document.getElementById("lang");
    const chatBox = document.getElementById("chat");
    const form = document.getElementById("form");
    const input = document.getElementById("msg");
    const voiceBtn = document.getElementById("voiceBtn");

    let savedLang = localStorage.getItem("preferredLang") || "en";
    langSel.value = savedLang;

    function getLang() {
      return localStorage.getItem("preferredLang") || "en";
    }

    langSel.addEventListener("change", (e) => {
      localStorage.setItem("preferredLang", e.target.value);
    });

    function addBubble(role, text) {
      const wrap = document.createElement("div");
      wrap.className = role === "user" ? "text-right" : "text-left";
      const bubble = document.createElement("div");
      bubble.className = (role === "user" ? "bg-blue-600 text-white" : "bg-gray-200 text-gray-900") + " inline-block px-3 py-2 rounded";
      bubble.textContent = text;
      wrap.appendChild(bubble);

      if (role === "bot") {
        const playBtn = document.createElement("button");
        playBtn.textContent = "üîä";
        playBtn.className = "ml-2 text-blue-600 hover:text-blue-800";
        playBtn.addEventListener("click", async () => {
          playBtn.textContent = "üéß Playing...";
          const audio = new Audio(`${SERVER}/api/tts?text=${encodeURIComponent(text)}&lang=${getLang()}&stream=true`);
          audio.play();
          audio.onended = () => (playBtn.textContent = "üîä");
        });
        wrap.appendChild(playBtn);
      }

      chatBox.appendChild(wrap);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const msg = input.value.trim();
      if (!msg) return;
      addBubble("user", msg);
      input.value = "";
      try {
        const res = await fetch(`${SERVER}/api/chat?lang=${getLang()}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: msg }),
        });
        const data = await res.json();
        addBubble("bot", data.reply || "No answer found.");
      } catch {
        addBubble("bot", "Network error.");
      }
    });

    let rec;
    if ("webkitSpeechRecognition" in window) {
      rec = new webkitSpeechRecognition();
      rec.continuous = false;
      rec.onresult = (e) => {
        input.value = e.results[0][0].transcript;
        form.requestSubmit();
      };
    }

    voiceBtn.addEventListener("click", () => {
      if (!rec) return alert("Speech not supported.");
      rec.lang = getLang() === "hi" ? "hi-IN" : getLang() === "or" ? "or-IN" : "en-IN";
      rec.start();
      voiceBtn.textContent = "üéß Listening...";
      rec.onend = () => (voiceBtn.textContent = "üéôÔ∏è");
    });

    const alertsEl = document.getElementById("alerts");
    document.getElementById("refreshAlerts").addEventListener("click", loadAlerts);

    async function loadAlerts() {
      alertsEl.innerHTML = "Loading...";
      try {
        const res = await fetch(`${SERVER}/api/alerts?lang=${getLang()}`);
        const arr = await res.json();
        alertsEl.innerHTML = arr.map((a) => `<li><strong>${a.title}</strong>: ${a.description}</li>`).join("");
      } catch {
        alertsEl.innerHTML = "Failed to load.";
      }
    }
    loadAlerts();

    const subForm = document.getElementById("subForm");
    subForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const phone = document.getElementById("phone").value.trim();
      const name = document.getElementById("name").value.trim();
      const channels = [];
      if (document.getElementById("chWhats").checked) channels.push("whatsapp");
      if (document.getElementById("chSms").checked) channels.push("sms");

      try {
        const res = await fetch(`${SERVER}/api/subscribe`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ phone_number: phone, name, preferred_language: getLang(), channels }),
        });
        const data = await res.json();
        document.getElementById("subResult").textContent = data.ok ? "‚úÖ Subscribed!" : "‚ùå Failed";
      } catch {
        document.getElementById("subResult").textContent = "Network error";
      }
    });

    const categorySelect = document.getElementById("categorySelect");
    const learnList = document.getElementById("learnList");

    async function loadCategories() {
      try {
        const res = await fetch(`${SERVER}/api/learn/categories?lang=${getLang()}`);
        const cats = await res.json();
        categorySelect.innerHTML = `<option value="">All</option>` + cats.map((c) => `<option value="${c.id}">${c.name}</option>`).join("");
      } catch {}
    }

    async function loadEntries(categoryId = "") {
      try {
        const url = new URL(`${SERVER}/api/learn/entries`);
        if (categoryId) url.searchParams.set("categoryId", categoryId);
        url.searchParams.set("lang", getLang());
        const res = await fetch(url);
        const items = await res.json();
        learnList.innerHTML = items.map((i) => `<div class="border-l-4 border-blue-500 pl-4"><strong>${i.title}</strong><p class="text-sm text-gray-600">${i.content}</p></div>`).join("");
      } catch {}
    }

    loadCategories();
    loadEntries();
    categorySelect.addEventListener("change", () => loadEntries(categorySelect.value));
  </script>
</body>
</html>